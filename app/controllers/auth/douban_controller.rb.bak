class Auth::DoubanController < ApplicationController
	skip_before_filter :authorize_user!

	def index
		auth_ext = Ecstore::AuthExt.find_by_id(cookies.signed[:_auth_ext].to_i) if cookies.signed[:_auth_ext]
		session[:from] = "external_auth"
		
		if auth_ext&&!auth_ext.expired?&&auth_ext.provider == 'douban'
			if auth_ext.account.nil?
				cookies.delete :_auth_ext
				redirect_to  Douban.authorize_url
			else
				sign_in(auth_ext.account)
				redirect_to after_user_sign_in_path
			end
		else
			redirect_to  Douban.authorize_url
		end
	end

	def callback
		return redirect_to(site_path) if params[:error].present?

		token =  Douban.request_token(params[:code])
		uid = token.douban_user_id
		auth_ext = Ecstore::AuthExt.where(:provider=>"douban",
									:uid=>uid).first_or_initialize(
									:access_token=>token.access_token,
									:expires_at=>token.expires_at,
									:expires_in=>token.expires_in)
		client = Douban.new(:access_token=>token.access_token,
							   :expires_at=>token.expires_at)
		auth_user = client.get("user/#{uid}").select do |k,v|
			%(name loc_name avatar).include?(k)
		end

		if auth_ext.new_record? || auth_ext.account.nil?
			session[:_auth_user] = (auth_user = Hashie::Mash.new(auth_user))
			session[:_auth_ext] = auth_ext
			@account = Ecstore::Account.new(:login_name=>auth_user.name)
			@account.auth_ext = auth_ext
			render "auth/accounts/new", :locals=>{:provider=>'douban'}
		else
			sign_in(auth_ext.account)
			redirect_to after_user_sign_in_path
		end
	end

	def cancel
		
	end
end